<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>多部门数据记录表</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
       .container {
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
        }

       .date-controls {
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            align-items: center;
            justify-content: space-between;
        }

       .select-group {
            display: flex;
            gap: 20px;
        }

        select {
            padding: 8px 12px;
            font-size: 16px;
            border-radius: 4px;
        }

       .calendar-table {
            width: 100%;
            border-collapse: collapse;
        }

       .calendar-table th,
       .calendar-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
            min-width: 120px;
            height: 40px;
            vertical-align: top;
        }

       .calendar-table th {
            background-color: #f5f5f5;
        }

       .day-number {
            font-weight: bold;
            margin-bottom: 4px;
        }

       .data-content {
            font-size: 12px;
            word-break: break-word;
        }

       .current-month {
            background-color: #fff;
        }

       .other-month {
            background-color: #f9f9f9;
            color: #999;
        }

       .calendar-table td:hover {
            background-color: #e0f7fa;
        }

       .record-list {
            margin-top: 20px;
        }

       .record-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
            justify-content: space-between;
        }

       .record-item .record-data {
            flex: 1;
        }

       .record-item .button-group {
            display: flex;
            gap: 10px;
        }

       .total-display {
            border: 1px solid #ddd;
            padding: 8px 12px;
            border-radius: 4px;
            background-color: #f9f9f9;
            min-width: 120px;
            text-align: center;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="date-controls">
            <div class="select-group">
                <select id="departmentSelect">
                    <option value="CS">CS</option>
                    <option value="hospitality">hospitality</option>
                    <option value="sales">sales</option>
                </select>
                <select id="yearSelect"></select>
                <select id="monthSelect" style="display: none;"></select>
            </div>
            <div id="salesTotal" class="total-display" style="display: none;">
                Sales Total: <span id="salesTotalValue">0</span>
            </div>
            <div id="hospitalityTotal" class="total-display" style="display: none;">
                Hospitality Total: <span id="hospitalityTotalValue">0</span>
            </div>
            <div id="csMonthTotal" class="total-display" style="display: none;">
                CS Month Total: <span id="csMonthTotalValue">0</span>
            </div>
            <div id="csYearTotal" class="total-display" style="display: none;">
                CS Year Total: <span id="csYearTotalValue">0</span>
            </div>
        </div>
        <table class="calendar-table" id="calendar">
            <thead>
                <tr id="tableHeader"></tr>
            </thead>
            <tbody id="calendarBody"></tbody>
        </table>
        <div class="record-list" id="recordList"></div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        // 创建选项的函数
        function createOption(value, text) {
            const option = document.createElement('option');
            option.value = value;
            option.text = text;
            return option;
        }

        // 初始化年份和月份选择器
        function initDateControls() {
            const yearSelect = document.getElementById('yearSelect');
            const monthSelect = document.getElementById('monthSelect');
            const currentYear = new Date().getFullYear();

            // 填充年份（前后10年）
            for (let i = currentYear - 3; i <= currentYear + 10; i++) {
                yearSelect.appendChild(createOption(i, i + '年'));
            }
            yearSelect.value = currentYear;

            // 填充月份
            for (let i = 1; i <= 12; i++) {
                monthSelect.appendChild(createOption(i, i + '月'));
            }
            monthSelect.value = new Date().getMonth() + 1;
        }

        // 获取指定年份某一周的日期范围，使用英文简写表示
        function getWeekDateRange(year, week) {
            const firstDayOfYear = new Date(year, 0, 1);
            const firstDayOfFirstWeek = new Date(firstDayOfYear);
            firstDayOfFirstWeek.setDate(firstDayOfFirstWeek.getDate() - firstDayOfFirstWeek.getDay() + (firstDayOfFirstWeek.getDay() === 0 ? -6 : 1));
            const startDate = new Date(firstDayOfFirstWeek);
            startDate.setDate(startDate.getDate() + (week - 1) * 7);
            const endDate = new Date(startDate);
            endDate.setDate(endDate.getDate() + 6);

            const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

            const formatDate = (date) => `${date.getDate()} ${monthNames[date.getMonth()]}`;
            return `${formatDate(startDate)} - ${formatDate(endDate)}`;
        }

        // 计算 sales 部门当年总计
        function calculateSalesYearlyTotal(year) {
            const savedRecords = JSON.parse(localStorage.getItem('salesRecords')) || [];
            let total = 0;
            savedRecords.forEach(record => {
                const parts = record.split(' ');
                const date = new Date(parts[0].replace(/\//g, '-'));
                if (date.getFullYear() === year) {
                    const data = parseFloat(parts[1]);
                    if (!isNaN(data)) {
                        total += data;
                    }
                }
            });
            return total;
        }

        // 计算 hospitality 部门当年总计
        function calculateHospitalityYearlyTotal(year) {
            let total = 0;
            for (let week = 1; week <= 52; week++) {
                const weekKey = `hospitality-${year}-week${week}`;
                const savedData = localStorage.getItem(weekKey);
                if (savedData) {
                    const data = parseFloat(savedData);
                    if (!isNaN(data)) {
                        total += data;
                    }
                }
            }
            return total;
        }

        // 计算 CS 部门当月总计
        function calculateCSMonthlyTotal(year, month) {
            let total = 0;
            const daysInMonth = new Date(year, month, 0).getDate();
            for (let date = 1; date <= daysInMonth; date++) {
                const dateKey = `CS-${year}-${month.toString().padStart(2, '0')}-${date.toString().padStart(2, '0')}`;
                const savedData = localStorage.getItem(dateKey);
                if (savedData) {
                    const data = parseFloat(savedData);
                    if (!isNaN(data)) {
                        total += data;
                    }
                }
            }
            return total;
        }

        // 计算 CS 部门当年总计
        function calculateCSYearlyTotal(year) {
            let total = 0;
            for (let month = 1; month <= 12; month++) {
                total += calculateCSMonthlyTotal(year, month);
            }
            return total;
        }

        // 生成日历
        function generateCalendar() {
            const department = document.getElementById('departmentSelect').value;
            const year = parseInt(document.getElementById('yearSelect').value);
            const month = parseInt(document.getElementById('monthSelect').value);
            const monthSelect = document.getElementById('monthSelect');
            const calendarBody = document.getElementById('calendarBody');
            const tableHeader = document.getElementById('tableHeader');
            const recordList = document.getElementById('recordList');
            const salesTotal = document.getElementById('salesTotal');
            const salesTotalValue = document.getElementById('salesTotalValue');
            const hospitalityTotal = document.getElementById('hospitalityTotal');
            const hospitalityTotalValue = document.getElementById('hospitalityTotalValue');
            const csMonthTotal = document.getElementById('csMonthTotal');
            const csMonthTotalValue = document.getElementById('csMonthTotalValue');
            const csYearTotal = document.getElementById('csYearTotal');
            const csYearTotalValue = document.getElementById('csYearTotalValue');
            calendarBody.innerHTML = '';
            tableHeader.innerHTML = '';
            recordList.innerHTML = '';
            salesTotal.style.display = 'none';
            hospitalityTotal.style.display = 'none';
            csMonthTotal.style.display = 'none';
            csYearTotal.style.display = 'none';

            if (department === 'CS') {
                monthSelect.style.display = 'block';
                // CS 部门按日显示，使用英文简写的星期表头
                tableHeader.innerHTML = `
                    <th>Sun</th>
                    <th>Mon</th>
                    <th>Tue</th>
                    <th>Wed</th>
                    <th>Thu</th>
                    <th>Fri</th>
                    <th>Sat</th>
                `;

                const firstDay = new Date(year, month - 1, 1);
                const lastDay = new Date(year, month, 0);
                const startDay = firstDay.getDay();
                const daysInMonth = lastDay.getDate();

                let date = 1;
                for (let i = 0; i < 6; i++) {
                    const row = document.createElement('tr');
                    for (let j = 0; j < 7; j++) {
                        const cell = document.createElement('td');
                        if (i === 0 && j < startDay) {
                            // 上个月日期
                            const prevMonthDay = new Date(year, month - 1, 0).getDate() - (startDay - j - 1);
                            cell.className = 'other-month';
                            cell.innerHTML = `<div class="day-number">${prevMonthDay}</div>`;
                        } else if (date > daysInMonth) {
                            break;
                        } else {
                            // 当月日期
                            cell.className = 'current-month';
                            const dateKey = `${department}-${year}-${month.toString().padStart(2, '0')}-${date.toString().padStart(2, '0')}`;
                            const savedData = localStorage.getItem(dateKey) || '';

                            cell.innerHTML = `
                                <div class="day-number">${date}</div>
                                <div class="data-content">${savedData}</div>
                            `;
                            cell.addEventListener('click', function () {
                                const newData = prompt('请输入数据：', savedData);
                                if (newData !== null) {
                                    try {
                                        localStorage.setItem(dateKey, newData);
                                        generateCalendar(); // 刷新日历显示
                                    } catch (error) {
                                        console.error('保存数据时出现错误：', error);
                                        alert('保存数据时出现错误，请稍后再试。');
                                    }
                                }
                            });
                            date++;
                        }
                        row.appendChild(cell);
                    }
                    calendarBody.appendChild(row);
                    if (date > daysInMonth) break;
                }

                // 显示 CS 部门当月总计和当年总计
                const monthTotal = calculateCSMonthlyTotal(year, month);
                const yearTotal = calculateCSYearlyTotal(year);
                csMonthTotal.style.display = 'block';
                csYearTotal.style.display = 'block';
                csMonthTotalValue.textContent = monthTotal;
                csYearTotalValue.textContent = yearTotal;
            } else if (department === 'hospitality') {
                monthSelect.style.display = 'none';
                const weeksPerRow = 8; // 每行显示的周数
                for (let week = 1; week <= 52; week += weeksPerRow) {
                    const dateRangeRow = document.createElement('tr');
                    const dataRow = document.createElement('tr');

                    for (let i = 0; i < weeksPerRow; i++) {
                        const currentWeek = week + i;
                        if (currentWeek > 52) break;

                        const dateRangeCell = document.createElement('td');
                        const dateRange = getWeekDateRange(year, currentWeek);
                        dateRangeCell.textContent = dateRange;
                        dateRangeRow.appendChild(dateRangeCell);

                        const dataCell = document.createElement('td');
                        const weekKey = `${department}-${year}-week${currentWeek}`;
                        const savedData = localStorage.getItem(weekKey) || '';

                        dataCell.innerHTML = `
                            <div class="data-content">${savedData}</div>
                        `;
                        dataCell.addEventListener('click', function () {
                            const newData = prompt('请输入数据：', savedData);
                            if (newData !== null) {
                                try {
                                    localStorage.setItem(weekKey, newData);
                                    generateCalendar(); // 刷新日历显示
                                } catch (error) {
                                    console.error('保存数据时出现错误：', error);
                                    alert('保存数据时出现错误，请稍后再试。');
                                }
                            }
                        });
                        dataRow.appendChild(dataCell);
                    }

                    calendarBody.appendChild(dateRangeRow);
                    calendarBody.appendChild(dataRow);
                }

                // 显示 hospitality 部门当年总计
                const total = calculateHospitalityYearlyTotal(year);
                hospitalityTotal.style.display = 'block';
                hospitalityTotalValue.textContent = total;
            } else if (department === 'sales') {
                monthSelect.style.display = 'none';
                const today = new Date();
                today.setFullYear(year);
                const day = String(today.getDate()).padStart(2, '0');
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const defaultDate = `${year}-${month}-${day}`;

                tableHeader.innerHTML = `<th>Date</th><th>Data</th>`;
                const row = document.createElement('tr');
                const dateCell = document.createElement('td');
                const dateInput = document.createElement('input');
                dateInput.type = 'text';
                flatpickr(dateInput, {
                    defaultDate: defaultDate,
                    dateFormat: 'Y-m-d',
                    maxDate: 'today'
                });
                dateCell.appendChild(dateInput);
                const dataCell = document.createElement('td');
                const input = document.createElement('input');
                input.type = 'text';
                const saveButton = document.createElement('button');
                saveButton.textContent = 'Save';
                saveButton.addEventListener('click', function () {
                    const selectedDate = dateInput.value;
                    const formattedDate = selectedDate.replace(/-/g, '/');
                    const data = input.value;
                    if (data) {
                        const record = `${formattedDate} ${data}`;
                        let savedRecords = JSON.parse(localStorage.getItem('salesRecords')) || [];
                        savedRecords.push(record);
                        // 按日期排序
                        savedRecords.sort((a, b) => {
                            const dateA = new Date(a.split(' ')[0]);
                            const dateB = new Date(b.split(' ')[0]);
                            return dateA - dateB;
                        });
                        localStorage.setItem('salesRecords', JSON.stringify(savedRecords));
                        generateCalendar();
                        input.value = '';
                    }
                });
                dataCell.appendChild(input);
                dataCell.appendChild(saveButton);
                row.appendChild(dateCell);
                row.appendChild(dataCell);
                calendarBody.appendChild(row);

                // 加载已保存的记录
                const savedRecords = JSON.parse(localStorage.getItem('salesRecords')) || [];
                // 排序后再显示
                savedRecords.sort((a, b) => {
                    const dateA = new Date(a.split(' ')[0]);
                    const dateB = new Date(b.split(' ')[0]);
                    return dateA - dateB;
                });
                savedRecords.forEach(record => {
                    const recordItem = document.createElement('div');
                    recordItem.className = 'record-item';
                    const recordData = document.createElement('span');
                    recordData.className = 'record-data';
                    recordData.textContent = record;
                    recordItem.appendChild(recordData);

                    const buttonGroup = document.createElement('div');
                    buttonGroup.className = 'button-group';

                    const editButton = document.createElement('button');
                    editButton.textContent = 'Edit';
                    editButton.addEventListener('click', function () {
                        const parts = record.split(' ');
                        const date = parts[0];
                        const oldData = parts[1];
                        const newData = prompt('请输入新的数据：', oldData);
                        if (newData!== null) {
                            let updatedRecords = JSON.parse(localStorage.getItem('salesRecords'));
                            const index = updatedRecords.indexOf(record);
                            updatedRecords[index] = `${date} ${newData}`;
                            // 编辑后重新排序
                            updatedRecords.sort((a, b) => {
                                const dateA = new Date(a.split(' ')[0]);
                                const dateB = new Date(b.split(' ')[0]);
                                return dateA - dateB;
                            });
                            localStorage.setItem('salesRecords', JSON.stringify(updatedRecords));
                            generateCalendar();
                        }
                    });
                    buttonGroup.appendChild(editButton);

                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Delete';
                    deleteButton.addEventListener('click', function () {
                        let updatedRecords = JSON.parse(localStorage.getItem('salesRecords'));
                        const index = updatedRecords.indexOf(record);
                        if (index!== -1) {
                            updatedRecords.splice(index, 1);
                            localStorage.setItem('salesRecords', JSON.stringify(updatedRecords));
                            generateCalendar();
                        }
                    });
                    buttonGroup.appendChild(deleteButton);

                    recordItem.appendChild(buttonGroup);

                    recordList.appendChild(recordItem);
                });

                // 显示当年总计
                const total = calculateSalesYearlyTotal(year);
                salesTotal.style.display = 'block';
                salesTotalValue.textContent = total;
            }
        }

        // 初始化
        initDateControls();
        generateCalendar();

        // 添加事件监听
        document.getElementById('departmentSelect').addEventListener('change', generateCalendar);
        document.getElementById('yearSelect').addEventListener('change', generateCalendar);
        document.getElementById('monthSelect').addEventListener('change', generateCalendar);
    </script>
</body>

</html>
